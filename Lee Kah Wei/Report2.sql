SET PAGESIZE 600
SET LINESIZE 1200
CREATE OR REPLACE PROCEDURE ON_DEMAND_REPORT(V_ROUTENO IN VARCHAR2, V_YEAR in VARCHAR2) AS

DEPARTURE_TERMINAL VARCHAR2(30);
ARRIVAL_TERMINAL VARCHAR2(30);
CHILD_PRICE NUMBER(5,2);
ADULT_PRICE NUMBER(5,2);
CITIZEN_PRICE NUMBER(5,2);
TICKET_PRICE NUMBER(5,2);
SCHEDULE_VALUE NUMBER(10,2);
TOTAL_NO_OF_TICKET_AVAILABLE NUMBER;
TOTAL_SCHEDULE_VALUE NUMBER(10,2);
TOTAL_COUNTER NUMBER;
V_ROUTE_EXIST NUMBER;

ROUTE_NOT_EXIST EXCEPTION;
PRAGMA exception_init(ROUTE_NOT_EXIST, -20108);

CURSOR PENDING_SCHEDULE IS
	SELECT BS.SCHEDULEID AS SCHEDULEID, DEPARTUREDATE, TO_CHAR(DEPARTURETIME, 'HH24:MI') AS TIME, SCHEDULESTATUS, NOOFTICKETAVAILABLE
	FROM BUSSCHEDULE BS
	WHERE BS.SCHEDULESTATUS != 'Cancelled' AND NOOFTICKETAVAILABLE != 0 AND BS.ROUTENO = V_ROUTENO AND (TO_DATE(SYSDATE, 'DD-MON-YYYY') - TO_DATE(DEPARTUREDATE, 'DD-MON-YYYY') > 0) AND TO_CHAR(DEPARTUREDATE, 'YYYY') = V_YEAR
	ORDER BY SCHEDULEID;

CURSOR GET_PRICE_TERMINAL IS
	SELECT DEPARTURETERMINAL, ARRIVALTERMINAL, CHILDPRICE, ADULTPRICE, SENIORCITIZENPRICE
	FROM ROUTE R, TICKETPRICE TP
	WHERE R.ROUTENO = V_ROUTENO AND R.ROUTENO = TP.ROUTENO AND TP.STATUS = 'CURRENT';

BEGIN
V_ROUTE_EXIST := FINDROUTENO(V_ROUTENO);

IF V_ROUTE_EXIST = 1 THEN

	DBMS_OUTPUT.put_line(chr(10));
	DBMS_OUTPUT.PUT_LINE(rpad(chr(9),8,chr(9))||rpad('Date',18,' ')||':'|| TO_CHAR(SYSDATE,'DD-MON-YYYY'));
	DBMS_OUTPUT.PUT_LINE(rpad(chr(9),8,chr(9))||rpad('Time',18,' ')||':'|| TO_CHAR(SYSDATE,'HH24:MI:SS'));
	DBMS_OUTPUT.PUT_LINE(rpad(chr(9),8,chr(9))||rpad('Generated By: ',18,' ')||':' || USER);
	DBMS_OUTPUT.put_line(chr(10));
	DBMS_OUTPUT.PUT_LINE(rpad(chr(9),1)||' LATEST DELAYED/CANCELLED SCHEDULE FOR ROUTE ' || V_ROUTENO || ' At YEAR ' || V_YEAR);
	DBMS_OUTPUT.PUT_LINE(rpad(chr(9),1)||'****************************************************************');

	DBMS_OUTPUT.PUT_LINE(CHR(10));
	DBMS_OUTPUT.PUT_LINE(RPAD('-',80,'-'));
	DBMS_OUTPUT.PUT_LINE(RPAD('Schedule ID', 15, ' ') || RPAD('DATE', 10, ' ') || RPAD('TIME', 10, ' ')  || RPAD('STATUS', 15, ' ') || RPAD('QUANTITY', 10, ' ') || RPAD('AVAILABLE REVENUE', 20, ' '));
	DBMS_OUTPUT.PUT_LINE(RPAD('-',80,'-'));

	TOTAL_NO_OF_TICKET_AVAILABLE := 0;
	TOTAL_SCHEDULE_VALUE := 0;
	TOTAL_COUNTER := 0;

	OPEN GET_PRICE_TERMINAL;
	LOOP
	FETCH GET_PRICE_TERMINAL INTO
		DEPARTURE_TERMINAL,
		ARRIVAL_TERMINAL,
		CHILD_PRICE,
		ADULT_PRICE,
		CITIZEN_PRICE;
	EXIT WHEN (GET_PRICE_TERMINAL%NOTFOUND);
	END LOOP;
	CLOSE GET_PRICE_TERMINAL;

	FOR SCHEDULE_REC IN PENDING_SCHEDULE LOOP
	
		TOTAL_NO_OF_TICKET_AVAILABLE := TOTAL_NO_OF_TICKET_AVAILABLE + SCHEDULE_REC.NOOFTICKETAVAILABLE;
		TOTAL_COUNTER := TOTAL_COUNTER + 1;
		TICKET_PRICE := (CHILD_PRICE + ADULT_PRICE + CITIZEN_PRICE) / 3;
		SCHEDULE_VALUE := TICKET_PRICE * SCHEDULE_REC.NOOFTICKETAVAILABLE;
		TOTAL_SCHEDULE_VALUE := TOTAL_SCHEDULE_VALUE + SCHEDULE_VALUE;
	
		DBMS_OUTPUT.PUT_LINE(RPAD(SCHEDULE_REC.SCHEDULEID, 15, ' ') || RPAD(SCHEDULE_REC.DEPARTUREDATE, 10, ' ') || RPAD(SCHEDULE_REC.TIME, 10, ' ') || RPAD(SCHEDULE_REC.SCHEDULESTATUS, 15, ' ') || RPAD(SCHEDULE_REC.NOOFTICKETAVAILABLE, 10, ' ') || RPAD('RM ' || TRIM(TO_CHAR(SCHEDULE_VALUE ,'9999D99')), 20, ' '));
	END LOOP;
	DBMS_OUTPUT.PUT_LINE(RPAD('-',80,'-'));
	DBMS_OUTPUT.PUT_LINE(CHR(10)||LPAD('-END OF REPORT-',40,' '));
	DBMS_OUTPUT.PUT_LINE(CHR(10));
	DBMS_OUTPUT.PUT_LINE(RPAD('DEPARTURE TERMINAL: ', 21, ' ') || RPAD(DEPARTURE_TERMINAL, 30, ' '));
	DBMS_OUTPUT.PUT_LINE(RPAD('ARRIVAL TERMINAL  : ', 21, ' ') || RPAD(ARRIVAL_TERMINAL, 30, ' '));
	DBMS_OUTPUT.PUT_LINE(CHR(10));
	DBMS_OUTPUT.PUT_LINE(RPAD('CHILD PRICE  : RM ', 19, ' ') || RPAD(TRIM(TO_CHAR(CHILD_PRICE ,'99D99')), 10, ' '));
	DBMS_OUTPUT.PUT_LINE(RPAD('ADULT PRICE  : RM ', 19, ' ') || RPAD(TRIM(TO_CHAR(ADULT_PRICE ,'99D99')), 10, ' '));
	DBMS_OUTPUT.PUT_LINE(RPAD('CITIZEN PRICE: RM ', 19, ' ') || RPAD(TRIM(TO_CHAR(CITIZEN_PRICE ,'99D99')), 10, ' '));
	DBMS_OUTPUT.PUT_LINE(RPAD('AVERAGE PRICE: RM ', 19, ' ') || RPAD(TRIM(TO_CHAR(TICKET_PRICE ,'99D99')), 10, ' '));
	DBMS_OUTPUT.PUT_LINE(CHR(10));
	DBMS_OUTPUT.PUT_LINE(RPAD('TOTAL AVAILABLE REVENUE: RM ', 28, ' ') || RPAD(TRIM(TO_CHAR(TOTAL_SCHEDULE_VALUE ,'99999D99')), 15, ' '));
	DBMS_OUTPUT.PUT_LINE(RPAD('TOTAL TICKET LEFT : ', 20, ' ') || RPAD(TOTAL_NO_OF_TICKET_AVAILABLE, 15, ' '));
	DBMS_OUTPUT.PUT_LINE(RPAD('TOTAL LEFTOVER SCHEDULE : ', 27, ' ') || RPAD(TOTAL_COUNTER, 15, ' '));

ELSE
	RAISE_APPLICATION_ERROR(-20108, 'ROUTE NO IS NOT VALID!');

END IF;

EXCEPTION
	WHEN ROUTE_NOT_EXIST THEN
		DBMS_OUTPUT.PUT_LINE(chr(10) || SQLERRM);
		DBMS_OUTPUT.PUT_LINE('ROUTE NO DOES NOT EXIST IN THE DATABASE.');
		DBMS_OUTPUT.PUT_LINE('CANNOT GENERATE REPORT!!');
END;
/
ACCEPT ROUTE char format 'a4'-
prompt 'Enter the ROUTE to find the AVAILABLE SCHEDULE  >'

ACCEPT YEAR date format 'YYYY'-
prompt 'Enter year to find  >'

EXEC ON_DEMAND_REPORT('&ROUTE', '&YEAR')